<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>CSV Uploader Directo</title>
<!-- Carga de Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>
<script>
    tailwind.config = {
        theme: {
            extend: {
                colors: {
                    'primary-blue': '#0070f3', // Un azul más vibrante para acción
                    'primary-hover': '#005edb',
                },
                fontFamily: {
                    sans: ['Inter', 'system-ui', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif'],
                },
            }
        }
    }
</script>
<style>
    /* Estilo para el hover de la zona de arrastre */
    #dropzone.drag-over {
        border-color: #0070f3; /* Primary Blue */
        background-color: #f0f8ff; 
    }
</style>
</head>
<body class="bg-gray-900 flex items-center justify-center min-h-screen p-4">

    <!-- Tarjeta Principal (Estilo oscuro para un look moderno) -->
    <div class="w-full max-w-lg bg-white rounded-xl shadow-2xl p-6 md:p-8 space-y-6">

        <!-- Título Centralizado -->
        <header class="text-center pb-4">
            <h1 class="text-3xl font-extrabold text-gray-900 tracking-tight">Carga Rápida de CSV</h1>
        </header>

        <!-- Sección de Carga de Archivo -->
        <section class="space-y-4">
            
            <!-- Dropzone / Selector de Archivo -->
            <div class="filebox border-2 border-dashed border-gray-300 rounded-xl p-8 text-center bg-gray-50 hover:border-primary-blue transition duration-200 cursor-pointer"
                 id="dropzone">
                <input id="file" type="file" accept=".csv,text/csv" style="display:none" />
                <div class="space-y-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 014 4.973V14a2 2 0 01-2 2h-3.414l-1.293 1.293a1 1 0 01-1.414 0L9.414 16H7z" />
                    </svg>

                    <button id="choose" type="button"
                            class="inline-flex items-center px-6 py-3 border border-transparent text-lg font-bold rounded-xl shadow-md text-white bg-primary-blue hover:bg-primary-hover focus:outline-none focus:ring-4 focus:ring-primary-blue focus:ring-opacity-50 transition duration-150 transform hover:scale-[1.02]">
                        Selecciona o Arrastra CSV
                    </button>
                    <div id="filename" class="text-sm text-gray-700 font-medium pt-1">Sin archivo.</div>
                </div>
            </div>

            <!-- Botón de Envío Único -->
            <div class="pt-4">
                <button id="send" 
                        class="w-full px-4 py-3 bg-green-600 text-white font-semibold text-lg rounded-xl hover:bg-green-700 transition duration-200 shadow-xl shadow-green-300/50">
                    Enviar al Webhook
                </button>
            </div>
        </section>

        <!-- Log de Estado -->
        <div id="log" class="log p-4 rounded-xl text-sm transition-all duration-300 ease-in-out bg-gray-100 text-gray-700 border border-gray-200 min-h-[40px]" role="status">
            Estado: Listo para cargar.
        </div>
    </div>

<script>
  // ** URL del Webhook integrada directamente en el código **
  const WEBHOOK_URL = 'https://dr-jorge-aso-n8n.pmsak1.easypanel.host/webhook/csv';

  // Variables
  const fileInput = document.getElementById('file');
  const filename = document.getElementById('filename');
  const sendBtn = document.getElementById('send');
  const log = document.getElementById('log');
  const drop = document.getElementById('dropzone');
  const choose = document.getElementById('choose');

  // --- Funciones de Utilidad ---

  /** Muestra un mensaje de estado en el log */
  function showLog(txt, type = 'info'){
    log.textContent = txt;
    log.className = 'log p-4 rounded-xl text-sm transition-all duration-300 ease-in-out';
    if(type === 'success'){
      log.classList.add('bg-green-100', 'text-green-800', 'border', 'border-green-300');
    } else if(type === 'error'){
      log.classList.add('bg-red-100', 'text-red-800', 'border', 'border-red-300');
    } else { // info/default
      log.classList.add('bg-gray-100', 'text-gray-700', 'border', 'border-gray-200');
    }
  }

  /** Muestra un modal simple en lugar de alert() */
  function showModal(message) {
      const modalId = 'custom-modal';
      let modal = document.getElementById(modalId);
      if (!modal) {
          modal = document.createElement('div');
          modal.id = modalId;
          modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300 opacity-0 pointer-events-none';
          modal.innerHTML = `
              <div class="bg-white rounded-xl shadow-2xl p-6 m-4 max-w-sm w-full transform transition-transform duration-300 scale-95">
                  <h3 class="text-xl font-bold text-gray-900 mb-4">Aviso</h3>
                  <p id="modal-message" class="text-gray-600 mb-6"></p>
                  <div class="flex justify-end">
                      <button id="modal-close-btn" class="px-4 py-2 bg-primary-blue text-white rounded-md hover:bg-primary-hover">
                          Aceptar
                      </button>
                  </div>
              </div>
          `;
          document.body.appendChild(modal);
          const closeBtn = document.getElementById('modal-close-btn');
          closeBtn.addEventListener('click', () => {
              modal.classList.add('opacity-0', 'pointer-events-none');
              modal.classList.remove('opacity-100');
          });
      }

      document.getElementById('modal-message').textContent = message;
      modal.classList.remove('opacity-0', 'pointer-events-none');
      modal.classList.add('opacity-100');
      document.getElementById('modal-close-btn').focus();
  }
  
  /** Reinicia el estado del formulario después del envío */
  function resetFormState() {
      // Limpia el input de archivo
      fileInput.value = ''; 
      // Reinicia el texto
      filename.textContent = 'Sin archivo.';
      // Muestra un log neutral
      showLog('Archivo enviado y estado reiniciado. Listo para una nueva carga.', 'info');
  }

  // --- Inicialización ---

  showLog('Estado: Listo para cargar.', 'info');


  // --- Event Listeners ---

  // 1. Seleccionar archivo (Click en botón/dropzone)
  choose.addEventListener('click', () => fileInput.click());

  // 2. Actualizar nombre de archivo
  fileInput.addEventListener('change', () => {
    if(fileInput.files.length) filename.textContent = 'Archivo seleccionado: ' + fileInput.files[0].name;
    else filename.textContent = 'Sin archivo.';
  });

  // 3. Drag & Drop
  drop.addEventListener('dragover', e => { e.preventDefault(); drop.classList.add('drag-over'); });
  drop.addEventListener('dragleave', e => { e.preventDefault(); drop.classList.remove('drag-over'); });
  drop.addEventListener('drop', e => {
    e.preventDefault();
    drop.classList.remove('drag-over');
    const f = e.dataTransfer.files && e.dataTransfer.files[0];
    if(f){ 
      // Verificar extensión
      if (!f.name.toLowerCase().endsWith('.csv')) {
        showModal('Por favor, selecciona un archivo con extensión .csv');
        filename.textContent = 'Sin archivo.';
        fileInput.value = ''; // Limpiar el input
        return;
      }
      
      fileInput.files = e.dataTransfer.files; 
      filename.textContent = 'Archivo seleccionado: ' + f.name; 
      showLog(`Archivo cargado: ${f.name}. Presiona Enviar.`, 'info');
    }
  });

  // 4. Enviar (Submit)
  sendBtn.addEventListener('click', async () => {
    if(!fileInput.files.length){ 
      showModal('Debes seleccionar o arrastrar un archivo .csv antes de enviarlo.'); 
      return; 
    }
    
    const file = fileInput.files[0];
    showLog('Enviando archivo: ' + file.name + ' ... Por favor, espera.', 'info');

    // Deshabilitar botón para evitar doble click y mostrar estado de carga
    sendBtn.disabled = true;
    sendBtn.classList.add('opacity-75', 'cursor-not-allowed');

    try {
      const fd = new FormData();
      // Campos necesarios para el webhook
      fd.append('file', file, file.name);
      fd.append('filename', file.name);

      // POST al webhook
      const resp = await fetch(WEBHOOK_URL, {
        method: 'POST',
        mode: 'cors', // Crucial para la comunicación con el webhook
        body: fd
      });

      // Procesamiento de la respuesta
      const text = await resp.text();
      
      if(resp.ok){
        // Muestra una vista previa corta de la respuesta
        const preview = text.length > 300 ? text.slice(0,300) + '...' : text;
        showLog('✅ ¡Enviado con éxito! Respuesta: ' + preview, 'success');
        resetFormState(); // <-- Reiniciar estado al éxito
      } else {
        const errorText = text || 'Sin cuerpo de respuesta.';
        showLog('❌ Error al enviar. Código: ' + resp.status + ' - ' + errorText, 'error');
      }
    } catch (err) {
      showLog('❌ Error de conexión/red: ' + (err.message || err), 'error');
      console.error("Error en la solicitud Fetch:", err);
    } finally {
      // Re-habilitar botón
      sendBtn.disabled = false;
      sendBtn.classList.remove('opacity-75', 'cursor-not-allowed');
    }
  });
</script>
</body>
</html>

